<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yukic_Music FlexGrid</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Orbitron:wght@700&display=swap"
        rel="stylesheet">
    <style>
        body {
            background-color: #050505;
            color: #ccc;
            margin: 0;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .container-64 {
            width: 100%;
            max-width: 100%;
            padding: 1rem;
        }

        /* Sticky Header */
        .header-64 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            background: #111;
            padding: 10px;
            border-bottom: 2px solid #333;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .title {
            font-family: 'Orbitron', sans-serif;
            margin: 0;
            color: #fff;
        }

        /* Master Controls */
        .master-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-small {
            padding: 4px 10px;
            font-size: 0.8rem;
        }

        .btn-primary {
            background: #0056b3;
            color: white;
        }

        .btn-primary:hover {
            background: #004494;
        }

        .btn-success {
            background: #198754;
            color: white;
        }

        .btn-success:hover {
            background: #157347;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5c636a;
        }

        .input-mini {
            background: #222;
            border: 1px solid #444;
            color: #fff;
            padding: 4px;
            font-size: 0.8rem;
            font-family: monospace;
        }

        .time-input {
            width: 70px;
            text-align: center;
        }

        /* Video Grid */
        .grid-64 {
            display: grid;
            gap: 2px;
            width: 100%;
            margin-bottom: 2rem;
            background: #000;
        }

        .track-cell {
            background: #000;
            position: relative;
            aspect-ratio: 16/9;
            overflow: hidden;
            border: 1px solid #222;
            cursor: pointer;
            /* Suggests clickable for merge */
        }

        .track-cell:hover {
            border-color: #555;
        }

        .player-frame {
            width: 100%;
            height: 100%;
            pointer-events: auto;
            /* Ensure player interactions work */
        }

        .track-number-overlay {
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 2px 6px;
            font-size: 0.8rem;
            font-family: 'Orbitron', sans-serif;
            pointer-events: none;
            z-index: 10;
        }

        /* Control List Area */
        .controls-section {
            background: #111;
            padding: 1rem;
            border-radius: 8px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 10px;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #1a1a1a;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid #333;
        }

        .row-number {
            font-family: 'Orbitron', sans-serif;
            color: #888;
            width: 30px;
            text-align: right;
        }

        .url-input {
            flex-grow: 1;
            min-width: 0;
        }

        .volume-slider {
            width: 80px;
            accent-color: #0056b3;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="container-64">
        <header class="header-64">
            <h1 class="title" style="font-size: 1.2rem;">Yukic_Music FlexGrid</h1>

            <div class="master-controls">
                <select id="layout-select" class="input-mini" style="width: auto; padding: 5px;">
                    <option value="4">4 (2x2)</option>
                    <option value="6-v">6 (3x2 Vertical)</option>
                    <option value="6-h">6 (2x3 Horizontal)</option>
                    <option value="8-v">8 (2x4 Vertical)</option>
                    <option value="8-h">8 (4x2 Horizontal)</option>
                    <option value="9">9 (3x3)</option>

                    <option value="12">12 (3x4 Vertical)</option>
                    <option value="12-4x3">12 (4x3 Horizontal)</option>
                    <option value="special-13">12 + Alpha (Base 4x4)</option>

                    <option value="15">15 (3x5 Vertical)</option>
                    <option value="15-5x3">15 (5x3 Horizontal)</option>

                    <option value="16" selected>16 (4x4)</option>
                    <option value="special-16-alpha">16 + Alpha (Base 5x5)</option>

                    <option value="18">18 (3x6)</option>

                    <option value="20">20 (4x5 Vertical)</option>
                    <option value="20-5x4">20 (5x4 Horizontal)</option>
                    <option value="special-20-big-alpha">20 + Big Alpha (Base 6x6)</option>
                    <option value="special-20-4alpha">20 + 4 Alpha (Base 6x6)</option>

                    <option value="24">24 (4x6)</option>
                    <option value="25">25 (5x5)</option>
                    <option value="28">28 (4x7)</option>
                    <option value="32">32 (4x8)</option>
                    <option value="36">36 (6x6)</option>
                    <option value="49">49 (7x7)</option>
                    <option value="64">64 (8x8)</option>
                    <option value="81">81 (9x9)</option>
                    <option value="100">100 (10x10)</option>
                    <option value="144">144 (12x12)</option>
                    <option value="225">225 (15x15)</option>
                </select>

                <button id="btn-merge-custom" class="btn btn-secondary btn-small"
                    title="Select a cell then click this to merge 2x2">Merge 2x2</button>

                <span>MASTER:</span>
                <input type="text" id="master-url" class="input-mini" style="width: 150px;" placeholder="URL...">
                <div style="display:flex; align-items:center; gap:2px;">
                    <input type="text" id="master-start" class="input-mini time-input" placeholder="0.00">
                    <span>~</span>
                    <input type="text" id="master-end" class="input-mini time-input" placeholder="10.00">
                </div>
                <!-- Master Volume -->
                <input type="range" id="master-volume" min="0" max="100" value="0" style="width: 80px;"
                    title="Master Volume (Init)">

                <button id="btn-apply-all" class="btn btn-primary btn-small">Set All</button>
                <div style="width:10px;"></div>
                <button id="btn-play-all" class="btn btn-success btn-small">Play All</button>
                <button id="btn-pause-all" class="btn btn-secondary btn-small">Pause All</button>
            </div>
        </header>

        <!-- Video Grid -->
        <div id="grid-container" class="grid-64"></div>

        <!-- Inputs List -->
        <div class="controls-section">
            <h3 style="margin-top:0; margin-bottom:1rem; border-bottom:1px solid #444; padding-bottom:0.5rem;">Track
                Settings</h3>
            <div id="controls-container" class="controls-grid"></div>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // Layout Definitions
        const LAYOUTS = {
            '16': { rows: 4, cols: 4, name: '16 (4x4)' },
            '9': { rows: 3, cols: 3, name: '9 (3x3)' },
            'special-13': {
                rows: 4, cols: 4, name: '12 + Alpha',
                spans: { 5: { r: 2, c: 2 } },
                skips: [6, 9, 10]
            },
            'special-16-alpha': { // [7,8,9, 12,13,14, 17,18,19] merged (3x3 center of 5x5)
                rows: 5, cols: 5, name: '16 + Alpha (5x5 base)',
                // Top-left of 3x3 merge is 7.
                spans: { 7: { r: 3, c: 3 } },
                skips: [8, 9, 12, 13, 14, 17, 18, 19]
            },
            'special-20-4alpha': { // [8,9,14,15] [10,11,16,17] [20,21,26,27] [22,23,28,29] merged
                rows: 6, cols: 6, name: '20 + 4 Alpha (6x6 base)',
                // 6x6 grid blocks
                spans: {
                    8: { r: 2, c: 2 },
                    10: { r: 2, c: 2 },
                    20: { r: 2, c: 2 },
                    22: { r: 2, c: 2 }
                },
                skips: [
                    9, 14, 15,    // from 8
                    11, 16, 17,   // from 10
                    21, 26, 27,   // from 20
                    23, 28, 29    // from 22
                ]
            },
            'special-20-big-alpha': { // All above merged into one 4x4
                rows: 6, cols: 6, name: '20 + Big Alpha',
                // Start at 8. Span 4x4.
                spans: { 8: { r: 4, c: 4 } },
                skips: [
                    9, 10, 11,
                    14, 15, 16, 17,
                    20, 21, 22, 23,
                    26, 27, 28, 29
                ]
            },
            '4': { rows: 2, cols: 2, name: '4 (2x2)' },
            '6-v': { rows: 3, cols: 2, name: '6 (3x2)' },
            '6-h': { rows: 2, cols: 3, name: '6 (2x3)' },
            '8-v': { rows: 2, cols: 4, name: '8 (2x4)' },
            '8-h': { rows: 4, cols: 2, name: '8 (4x2)' },
            '12': { rows: 3, cols: 4, name: '12 (3x4)' },
            '12-4x3': { rows: 4, cols: 3, name: '12 (4x3)' },
            '15': { rows: 3, cols: 5, name: '15 (3x5)' },
            '15-5x3': { rows: 5, cols: 3, name: '15 (5x3)' },
            '18': { rows: 3, cols: 6, name: '18 (3x6)' },
            '20': { rows: 4, cols: 5, name: '20 (4x5)' },
            '20-5x4': { rows: 5, cols: 4, name: '20 (5x4)' },
            '24': { rows: 4, cols: 6, name: '24 (4x6)' },
            '25': { rows: 5, cols: 5, name: '25 (5x5)' },
            '28': { rows: 4, cols: 7, name: '28 (4x7)' },
            '32': { rows: 4, cols: 8, name: '32 (4x8)' },
            '36': { rows: 6, cols: 6, name: '36 (6x6)' },
            '49': { rows: 7, cols: 7, name: '49 (7x7)' },
            '64': { rows: 8, cols: 8, name: '64 (8x8)' },
            '81': { rows: 9, cols: 9, name: '81 (9x9)' },
            '100': { rows: 10, cols: 10, name: '100 (10x10)' },
            '144': { rows: 12, cols: 12, name: '144 (12x12)' },
            '225': { rows: 15, cols: 15, name: '225 (15x15)' },
        };

        let currentPlayersCount = 0;
        let currentLayoutKey = '16';
        let customSpans = {};
        let selectedCellId = null;

        const players = new Map();
        const loops = new Map();
        let inputCache = [];

        function parseTime(str) {
            if (!str) return 0;
            str = str.replace('：', ':');
            const parts = str.split(':');
            if (parts.length === 2) {
                return parseInt(parts[0]) * 60 + parseFloat(parts[1]);
            } else {
                return parseFloat(str);
            }
        }

        function extractVideoId(url) {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function init(layoutKey = '16') {
            currentLayoutKey = layoutKey;
            const config = LAYOUTS[layoutKey];
            customSpans = {}; // Reset custom merges
            selectedCellId = null;
            renderGrid(config);
        }

        function renderGrid(config) {
            const gridContainer = document.getElementById('grid-container');
            const controlsContainer = document.getElementById('controls-container');

            gridContainer.innerHTML = '';
            controlsContainer.innerHTML = '';
            inputCache = [];

            // Destroy players
            players.forEach(p => { try { p.destroy(); } catch (e) { } });
            players.clear();
            loops.forEach(l => clearInterval(l));
            loops.clear();

            gridContainer.style.gridTemplateColumns = `repeat(${config.cols}, 1fr)`;

            // Merge logic: Combine Config + Custom
            const activeSpans = { ... (config.spans || {}), ...customSpans };
            const activeSkips = [... (config.skips || [])];

            // Recalculate skips from customSpans
            for (const [idxStr, span] of Object.entries(customSpans)) {
                const idx = parseInt(idxStr);
                const r = span.r;
                const c = span.c;
                for (let rr = 0; rr < r; rr++) {
                    for (let cc = 0; cc < c; cc++) {
                        if (rr === 0 && cc === 0) continue;
                        const baseRow = Math.floor(idx / config.cols);
                        const baseCol = idx % config.cols;
                        const targetId = (baseRow + rr) * config.cols + (baseCol + cc);
                        if (!activeSkips.includes(targetId) && targetId < config.rows * config.cols) {
                            activeSkips.push(targetId);
                        }
                    }
                }
            }

            const totalCells = config.rows * config.cols;
            let playerIndex = 0;

            for (let i = 0; i < totalCells; i++) {
                if (activeSkips.includes(i)) continue;

                const cell = document.createElement('div');
                cell.className = 'track-cell';
                cell.dataset.rawId = i;

                // Select event (delegated in cell for simplicity)
                cell.onclick = (e) => {
                    // Ignore clicks on player if API captures them? 
                    // Actually overlays might block.
                    // Let's use overlay click logic if needed, but here simple click wrapper works.
                    // But if iframe is on top, click won't bubble unless pointer-events:none on iframe.
                    // We need iframe to be interactive? Typically yes.
                    // Solution: Click on track-number-overlay to select? Or a border area.
                    // Assuming clicks bubble from overlay.
                    selectCellForMerge(i, cell);
                };

                if (activeSpans[i]) {
                    const span = activeSpans[i];
                    cell.style.gridRow = `span ${span.r}`;
                    cell.style.gridColumn = `span ${span.c}`;
                }

                const currentId = playerIndex;
                cell.id = `cell-${currentId}`;
                cell.innerHTML = `
                    <div class="track-number-overlay" style="pointer-events:none;">#${currentId + 1}</div>
                    <div id="player-${currentId}" class="player-frame"></div>
                    <!-- Selection border helper -->
                    <div class="selection-overlay" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;border:3px solid transparent;z-index:20;"></div>
                `;
                gridContainer.appendChild(cell);

                // Control
                const row = document.createElement('div');
                row.className = 'control-row';
                row.innerHTML = `
                    <span class="row-number">#${currentId + 1}</span>
                    <input type="text" class="input-mini url-input" placeholder="YouTube URL" data-id="${currentId}">
                    <input type="text" class="input-mini time-input start-time" value="0.00" placeholder="Start" data-id="${currentId}">
                    <span>~</span>
                    <input type="text" class="input-mini time-input end-time" value="10.00" placeholder="End" data-id="${currentId}">
                    <input type="range" class="volume-slider" min="0" max="100" value="0" data-id="${currentId}" title="Volume">
                    <button class="btn btn-primary btn-small load-btn" data-id="${currentId}">Go</button>
                `;
                controlsContainer.appendChild(row);

                inputCache[currentId] = {
                    url: row.querySelector('.url-input'),
                    start: row.querySelector('.start-time'),
                    end: row.querySelector('.end-time'),
                    volume: row.querySelector('.volume-slider')
                };

                playerIndex++;
            }
            currentPlayersCount = playerIndex;
            selectedCellId = null;
        }

        function selectCellForMerge(rawId, element) {
            // Visual feedback via .selection-overlay
            document.querySelectorAll('.selection-overlay').forEach(el => el.style.borderColor = 'transparent');
            const overlay = element.querySelector('.selection-overlay');
            if (overlay) overlay.style.borderColor = '#0d6efd';

            selectedCellId = rawId;
        }

        document.getElementById('btn-merge-custom').addEventListener('click', () => {
            if (selectedCellId === null) {
                alert('先に結合したいセルの左上をクリックして選択してください。');
                return;
            }

            // Check boundary
            const config = LAYOUTS[currentLayoutKey];
            const row = Math.floor(selectedCellId / config.cols);
            const col = selectedCellId % config.cols;

            if (row + 1 >= config.rows || col + 1 >= config.cols) {
                alert('右端や下端のセルからは2x2結合できません。');
                return;
            }

            // Register merge
            customSpans[selectedCellId] = { r: 2, c: 2 };

            // Re-render
            renderGrid(config);
        });

        // Initial Load
        init('16');

        document.getElementById('layout-select').addEventListener('change', (e) => {
            init(e.target.value);
        });

        function onYouTubeIframeAPIReady() { }

        function createPlayer(index, videoId) {
            if (players.has(index)) {
                try { players.get(index).destroy(); } catch (e) { }
                players.delete(index);
                if (loops.has(index)) { clearInterval(loops.get(index)); loops.delete(index); }
            }

            const cell = document.getElementById(`cell-${index}`);
            let placeholder = document.getElementById(`player-${index}`);

            if (!placeholder && cell) {
                placeholder = document.createElement('div');
                placeholder.id = `player-${index}`;
                placeholder.className = 'player-frame';
                // Insert before selection overlay to keep overlay on top
                const overlay = cell.querySelector('.selection-overlay');
                cell.insertBefore(placeholder, overlay);
            }

            if (!placeholder) return;

            const p = new YT.Player(`player-${index}`, {
                height: '100%',
                width: '100%',
                videoId: videoId,
                playerVars: { autoplay: 1, controls: 0, disablekb: 1, fs: 0, modestbranding: 1, iv_load_policy: 3, mute: 1, playsinline: 1 },
                events: {
                    onReady: (e) => {
                        const volSlider = inputCache[index]?.volume;
                        if (volSlider) {
                            const vol = parseInt(volSlider.value);
                            if (vol > 0) { e.target.unMute(); e.target.setVolume(vol); }
                            else { e.target.mute(); }
                        }
                    },
                    onStateChange: (e) => onPlayerStateChange(e, index)
                }
            });
            players.set(index, p);
        }

        function onPlayerStateChange(event, index) {
            if (event.data === YT.PlayerState.PLAYING) {
                if (loops.has(index)) clearInterval(loops.get(index));
                loops.set(index, setInterval(() => checkLoop(index), 100));
            } else {
                if (loops.has(index)) { clearInterval(loops.get(index)); loops.delete(index); }
            }
        }

        function checkLoop(index) {
            const player = players.get(index);
            if (!player || typeof player.getCurrentTime !== 'function') return;

            const inputs = inputCache[index];
            if (!inputs) return;

            const start = parseTime(inputs.start.value) || 0;
            const end = parseTime(inputs.end.value) || 10;
            if (end <= start) return;

            try {
                if (player.getCurrentTime() >= end) {
                    player.seekTo(start, true);
                }
            } catch (e) { }
        }

        // Delegated listeners
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('load-btn')) {
                const id = parseInt(e.target.dataset.id);
                if (inputCache[id]) {
                    const url = inputCache[id].url.value;
                    const videoId = extractVideoId(url);
                    if (videoId) createPlayer(id, videoId);
                }
            }
        });

        document.addEventListener('input', (e) => {
            if (e.target.classList.contains('volume-slider')) {
                const id = parseInt(e.target.dataset.id);
                const player = players.get(id);
                const vol = parseInt(e.target.value);
                if (player && typeof player.setVolume === 'function') {
                    if (vol > 0) { player.unMute(); player.setVolume(vol); }
                    else { player.mute(); }
                }
            }
        });

        document.getElementById('btn-apply-all').addEventListener('click', () => {
            const url = document.getElementById('master-url').value;
            const start = document.getElementById('master-start').value;
            const end = document.getElementById('master-end').value;
            const vol = document.getElementById('master-volume').value;
            const videoId = extractVideoId(url);

            for (let i = 0; i < currentPlayersCount; i++) {
                if (!inputCache[i]) continue;
                if (url) inputCache[i].url.value = url;
                inputCache[i].start.value = start;
                inputCache[i].end.value = end;
                inputCache[i].volume.value = vol;

                const player = players.get(i);
                if (player && typeof player.setVolume === 'function') {
                    const v = parseInt(vol);
                    if (v > 0) { player.unMute(); player.setVolume(v); }
                    else { player.mute(); }
                }

                if (videoId) {
                    setTimeout(() => createPlayer(i, videoId), i * 150);
                }
            }
        });

        document.getElementById('btn-play-all').addEventListener('click', () => {
            players.forEach(p => p.playVideo());
        });

        document.getElementById('btn-pause-all').addEventListener('click', () => {
            players.forEach(p => p.pauseVideo());
        });

        document.addEventListener('keydown', (e) => {
            if (e.target.classList.contains('url-input') && e.key === 'Enter') {
                const id = parseInt(e.target.dataset.id);
                const videoId = extractVideoId(e.target.value);
                if (videoId) createPlayer(id, videoId);
            }
        });
    </script>
</body>

</html>